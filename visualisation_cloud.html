<!-- SEULEMENT LA PARTIE JAVASCRIPT MODIFIÉE -->
<script>
const apiKey = "6C7J88FPA3BL0998";
const channelID = "2933717";
const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=20&api_key=${apiKey}`;

// Fonction pour convertir la date UTC en format local (date + heure)
function convertToLocalTime(utcDateStr) {
  const date = new Date(utcDateStr);
  return date.toLocaleString('fr-FR').replace(',', '');
}

fetch(url)
  .then(response => response.json())
  .then(data => {
    const feeds = data.feeds; // NE PAS inverser ici pour que les plus récentes soient à droite

    const labels = feeds.map(f => convertToLocalTime(f.created_at));
    const temp = feeds.map(f => parseFloat(f.field1));
    const courant = feeds.map(f => parseFloat(f.field2));
    const pression = feeds.map(f => parseFloat(f.field3));
    const niveauHuile = feeds.map(f => f.field4 === "Haut" ? 1 : 0);

    const makeChart = (ctxId, label, dataArr, color, yMax, yStep, unit, customTicks = null) => {
      new Chart(document.getElementById(ctxId).getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label + (unit ? ' (' + unit + ')' : ''),
            data: dataArr,
            borderColor: color,
            backgroundColor: color.replace('1)', '0.2)').replace('rgb', 'rgba'),
            fill: true,
            tension: 0.3,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              min: 0,
              max: yMax,
              ticks: {
                stepSize: yStep,
                callback: customTicks || undefined
              },
              title: { display: true, text: label }
            },
            x: {
              title: { display: true, text: 'Date et Heure' },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (label === "Niveau d'huile") {
                    return "Niveau d'huile : " + (context.raw === 1 ? "Haut" : "Bas");
                  }
                  return `${context.dataset.label}: ${context.formattedValue}`;
                }
              }
            }
          }
        }
      });
    };

    makeChart("tempChart", "Température", temp, "rgb(255, 0, 0, 1)", 100, 10, "°C");
    makeChart("courantChart", "Courant", courant, "rgb(0, 0, 255, 1)", 1000, 100, "A");
    makeChart("pressionChart", "Pression", pression, "rgb(0, 128, 0, 1)", 5, 0.5, "bars");
    makeChart("huileChart", "Niveau d'huile", niveauHuile, "rgb(255, 165, 0, 1)", 1, 1, "",
      value => value === 1 ? "Haut" : "Bas"
    );

    const tbody = document.querySelector("#dataTable tbody");
    // Affichage dans le tableau inversé (plus récent en haut)
    feeds.slice().reverse().forEach((f) => {
      const tempVal = parseFloat(f.field1 || 0);
      const courantVal = parseFloat(f.field2 || 0);
      const pressionVal = parseFloat(f.field3 || 0);
      const niveau = f.field4 || "-";

      const etats = [];
      let className = "normal";

      if (tempVal >= 90) {
        etats.push("Surchauffe-critique");
        className = "surchauffe-critique";
      } else if (tempVal >= 80) {
        etats.push("Surchauffe");
        className = "surchauffe";
      }

      if (courantVal >= 910) {
        etats.push("Surintensité");
        className = "surintensite";
      }

      if (pressionVal >= 3) {
        etats.push("Surpression");
        className = "surpression";
      }

      if (niveau === "Bas") {
        etats.push("Faible_huile");
        className = "faible-huile";
      }

      const etat = etats.length > 0 ? etats.join(" + ") : "Normal";

      const row = `<tr class="${className}">
        <td>${convertToLocalTime(f.created_at)}</td>
        <td>${f.field1 || "-"}</td>
        <td>${f.field2 || "-"}</td>
        <td>${f.field3 || "-"}</td>
        <td>${niveau}</td>
        <td>${etat}</td>
      </tr>`;
      tbody.innerHTML += row;
    });
  })
  .catch(err => console.error("Erreur de chargement ThingSpeak:", err));

// Actualisation automatique toutes les 15 secondes
setTimeout(() => location.reload(), 15000);
</script>
