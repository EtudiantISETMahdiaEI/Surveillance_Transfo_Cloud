<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surveillance Transformateur - Graphiques en temps réel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    tr.normal {
      background-color: #ffffff;
    }
    tr.surchauffe {
      background-color: #f8d7da; /* rouge clair */
    }
    tr.surintensite {
      background-color: #fff3cd; /* jaune clair */
    }
    tr.declenchement {
      background-color: #d1ecf1; /* bleu clair */
    }
    canvas {
      max-width: 100%;
      height: 300px;
      margin-bottom: 40px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Surveillance Transformateur - Graphiques en temps réel</h1>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Heure / Date</th>
        <th>Température (°C)</th>
        <th>Courant (A)</th>
        <th>Pression (bars)</th>
        <th>Niveau d'huile</th>
        <th>État</th>
      </tr>
    </thead>
    <tbody>
      <!-- Les données seront insérées ici dynamiquement -->
    </tbody>
  </table>

  <canvas id="tempChart"></canvas>
  <canvas id="courantChart"></canvas>
  <canvas id="pressionChart"></canvas>
  <canvas id="huileChart"></canvas>

  <script>
    const dataUrl = "https://tondomaine.com/get_data.php"; // <-- Mets ici l’URL complète vers ton fichier PHP

    async function fetchData() {
      try {
        const response = await fetch(dataUrl);
        if (!response.ok) throw new Error("Erreur HTTP " + response.status);
        const data = await response.json();
        return data.reverse();  // Pour afficher du plus ancien au plus récent
      } catch (error) {
        console.error("Erreur fetch:", error);
        return null;
      }
    }

    function updateTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        const etat = (row.Etat || "").toUpperCase();
        let className = "";
        if (etat === "SURCHAUFFE") className = "surchauffe";
        else if (etat === "SURINTENSITÉ" || etat === "SURINTENSITE") className = "surintensite";
        else if (etat === "DÉCLENCHEMENT" || etat === "DECLENCHEMENT") className = "declenchement";
        else className = "normal";

        tr.className = className;
        tr.innerHTML = `
          <td>${row.Heure_date || ""}</td>
          <td>${row.Temperature || ""}</td>
          <td>${row.Courant || ""}</td>
          <td>${row.Pression || ""}</td>
          <td>${row.Niveau_huile || ""}</td>
          <td>${row.Etat || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    let tempChart, courantChart, pressionChart, huileChart;

    function createCharts(labels, temperatureData, courantData, pressionData, huileData) {
      const ctxTemp = document.getElementById('tempChart').getContext('2d');
      const ctxCourant = document.getElementById('courantChart').getContext('2d');
      const ctxPression = document.getElementById('pressionChart').getContext('2d');
      const ctxHuile = document.getElementById('huileChart').getContext('2d');

      if (tempChart) tempChart.destroy();
      if (courantChart) courantChart.destroy();
      if (pressionChart) pressionChart.destroy();
      if (huileChart) huileChart.destroy();

      tempChart = new Chart(ctxTemp, chartOptions('Température', temperatureData, 'rgba(255, 0, 0, 1)', 100, 10, '°C', labels));
      courantChart = new Chart(ctxCourant, chartOptions('Courant', courantData, 'rgba(0, 0, 255, 1)', 1000, 100, 'A', labels));
      pressionChart = new Chart(ctxPression, chartOptions('Pression', pressionData, 'rgba(0, 128, 0, 1)', 5, 0.5, 'bars', labels));
      huileChart = new Chart(ctxHuile, chartOptions(
        "Niveau d'huile",
        huileData,
        'rgba(255, 165, 0, 1)',
        1,
        1,
        '',
        labels,
        value => value === 1 ? 'Haut' : 'Bas'
      ));
    }

    function chartOptions(label, data, color, yMax, yStep, unit, labels, tooltipCallback) {
      return {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label + (unit ? ' (' + unit + ')' : ''),
            data: data,
            borderColor: color,
            backgroundColor: color.replace('1)', '0.2)').replace('rgba', 'rgba'),
            fill: true,
            tension: 0.3,
            pointRadius: 3,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              min: 0,
              max: yMax,
              ticks: { stepSize: yStep },
              title: { display: true, text: label + (unit ? ' (' + unit + ')' : '') }
            },
            x: {
              title: { display: true, text: 'Date/Heure' },
              ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 10 }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  if (tooltipCallback) {
                    return label + ': ' + tooltipCallback(context.raw);
                  }
                  return context.dataset.label + ': ' + context.formattedValue;
                }
              }
            }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
      };
    }

    async function refreshData() {
      const data = await fetchData();
      if (!data) return;

      const labels = data.map(d => d.Heure_date);
      const temperatureData = data.map(d => parseFloat(d.Temperature) || 0);
      const courantData = data.map(d => parseFloat(d.Courant) || 0);
      const pressionData = data.map(d => parseFloat(d.Pression) || 0);
      const huileData = data.map(d => (d.Niveau_huile && d.Niveau_huile.toLowerCase() === 'haut') ? 1 : 0);

      updateTable(data);
      createCharts(labels, temperatureData, courantData, pressionData, huileData);
    }

    refreshData();
    setInterval(refreshData, 20000);
  </script>
</body>
</html>
