<script>
    const channelID = 2933717;
    const readAPIKey = "6C7J88FPA3BL0998";

    function fetchData() {
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1${readAPIKey ? '&api_key=' + readAPIKey : ''}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.feeds && data.feeds.length > 0) {
                    const feed = data.feeds[0];

                    let temp = parseFloat(feed.field1);
                    let courant = parseFloat(feed.field2);
                    let pression = parseFloat(feed.field3);

                    // üîÑ Traitement robuste du niveau d'huile
                    let niveauHuileRaw = (feed.field4 || "").toString().trim().toLowerCase();
                    let niveauHuile = "N/A";
                    let couleurHuile = "gray";
                    let iconeHuile = "fas fa-question-circle";

                    if (niveauHuileRaw === "1" || niveauHuileRaw === "haut") {
                        niveauHuile = "Haut";
                        couleurHuile = "green";
                        iconeHuile = "fas fa-oil-can";
                    } else if (niveauHuileRaw === "0" || niveauHuileRaw === "bas") {
                        niveauHuile = "Bas";
                        couleurHuile = "red";
                        iconeHuile = "fas fa-oil-can";
                    }

                    // ‚úÖ Formatage des donn√©es
                    temp = !isNaN(temp) ? temp.toFixed(2) : "N/A";
                    courant = !isNaN(courant) ? courant.toFixed(2) : "N/A";
                    pression = !isNaN(pression) ? pression.toFixed(2) : "N/A";

                    // ‚úÖ D√©tection d'anomalies
                    let alertes = [];

                    if (!isNaN(temp)) {
                        if (temp >= 90) alertes.push("Surchauffe-critique");
                        else if (temp >= 80) alertes.push("Surchauffe");
                    }
                    if (!isNaN(courant) && courant >= 910) alertes.push("Surintensit√©");
                    if (!isNaN(pression) && pression >= 3) alertes.push("Surpression");
                    if (niveauHuile === "Bas") alertes.push("Faible huile");

                    let etat = alertes.length > 0 ? alertes.join(" | ") : "Normal";
                    const dateHeure = feed.created_at ? new Date(feed.created_at).toLocaleString("fr-FR") : "N/A";

                    // ‚úÖ Affichage HTML
                    document.getElementById('data-container').innerHTML = `
                        <h2><i class="fas fa-bolt"></i> Donn√©es r√©centes Transfo-SITEX</h2>
                        <p><i class="fas fa-thermometer-half"></i> Temp√©rature : <strong>${temp} ¬∞C</strong></p>
                        <p><i class="fas fa-charging-station"></i> Courant : <strong>${courant} A</strong></p>
                        <p><i class="fas fa-tachometer-alt"></i> Pression : <strong>${pression} bars</strong></p>
                        <p style="color:${couleurHuile}"><i class="${iconeHuile}"></i> Niveau d'huile : <strong>${niveauHuile}</strong></p>
                        <p><i class="fas fa-exclamation-triangle"></i> √âtat : <strong>${etat}</strong></p>
                        <p><i class="fas fa-clock"></i> Date/Heure : <strong>${dateHeure}</strong></p>
                    `;

                } else {
                    document.getElementById('data-container').innerHTML = `
                        <h2><i class="fas fa-bolt"></i> Donn√©es r√©centes Transfo-SITEX</h2>
                        <p>‚Ñπ Aucune donn√©e trouv√©e.</p>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('data-container').innerHTML = `
                    <h2><i class="fas fa-bolt"></i> Donn√©es r√©centes Transfo-SITEX</h2>
                    <p> Erreur de chargement : ${error}</p>
                `;
            });
    }

    // üîÅ Rafra√Æchissement synchro toutes les 5 secondes
    const synchronizeRefresh = () => {
        const now = Date.now();
        const delay = 5000 - (now % 5000); // synchronise pile √† :00, :05, :10...

        setTimeout(() => {
            const seconds = new Date().getSeconds();

            // Actualisation toutes les 15 secondes uniquement
            if (seconds % 15 === 0) {
                fetchData();
            }

            // Relance la boucle toutes les 5 secondes
            synchronizeRefresh();
        }, delay);
    };

    fetchData();        // 1√®re r√©cup√©ration imm√©diate
    synchronizeRefresh(); // D√©marre la synchro
</script>
