<div id="data-container">Chargement des données...</div>

<script>
    const channelID = 2933717;  // Ton Channel ThingSpeak
    const readAPIKey = "6C7J88FPA3BL0998";       // Clé si canal privé sinon vide

    function fetchData() {
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1${readAPIKey ? '&api_key=' + readAPIKey : ''}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.feeds && data.feeds.length > 0) {
                    const feed = data.feeds[0];

                    let temp = feed.field1 ? parseFloat(feed.field1) : NaN;
                    let courant = feed.field2 ? parseFloat(feed.field2) : NaN;
                    let pression = feed.field3 ? parseFloat(feed.field3) : NaN;
                    let niveauHuileRaw = (feed.field4 !== undefined) ? feed.field4 : null;

                    let niveauHuile = null;
                    if (niveauHuileRaw === "1") {
                        niveauHuile = "Haut";
                    } else if (niveauHuileRaw === "0") {
                        niveauHuile = "Bas";
                    }

                    let alertes = [];

                    if (!isNaN(temp)) {
                        if (temp >= 90) alertes.push("Surchauffe-critique");
                        else if (temp >= 80) alertes.push("Surchauffe");
                    }
                    if (!isNaN(courant) && courant >= 910) {
                        alertes.push("Surintensité");
                    }
                    if (!isNaN(pression) && pression >= 3) {
                        alertes.push("Surpression");
                    }
                    if (niveauHuile === "Bas") {
                        alertes.push("Faible_huile");
                    }

                    let etat = alertes.length > 0 ? alertes.join(" | ") : "Normal";

                    const dateHeure = feed.created_at ? new Date(feed.created_at).toLocaleString("fr-FR") : "N/A";

                    let html = "";

                    if (!isNaN(temp)) {
                        html += `<p><i class="fas fa-thermometer-half"></i> Température : <strong>${temp.toFixed(2)} °C</strong></p>`;
                    } else {
                        html += `<p>Température : <em>Non disponible</em></p>`;
                    }

                    if (!isNaN(courant)) {
                        html += `<p><i class="fas fa-charging-station"></i> Courant : <strong>${courant.toFixed(2)} A</strong></p>`;
                    }

                    if (!isNaN(pression)) {
                        html += `<p><i class="fas fa-tachometer-alt"></i> Pression : <strong>${pression.toFixed(2)} bars</strong></p>`;
                    }

                    if (niveauHuile !== null) {
                        html += `<p><i class="fas fa-oil-can"></i> Niveau d'huile : <strong>${niveauHuile}</strong></p>`;
                    }

                    html += `<p><i class="fas fa-exclamation-triangle"></i> État : <strong>${etat}</strong></p>`;
                    html += `<p><i class="fas fa-clock"></i> Date/Heure : <strong>${dateHeure}</strong></p>`;

                    document.getElementById('data-container').innerHTML = html;
                } else {
                    document.getElementById('data-container').innerHTML = "<p>ℹ Aucune donnée trouvée.</p>";
                }
            })
            .catch(error => {
                document.getElementById('data-container').innerHTML = `<p>Erreur de chargement des données : ${error}</p>`;
            });
    }

    fetchData();
    setInterval(fetchData, 20000);  // rafraîchir toutes les 20 secondes
</script>
