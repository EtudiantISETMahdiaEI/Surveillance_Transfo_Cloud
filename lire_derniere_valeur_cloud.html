<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Donn√©es Transfo-SITEX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <div id="data-container"></div>

    <script>
        const channelID = 2933717;
        const readAPIKey = "6C7J88FPA3BL0998";

        function fetchData() {
            const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1${readAPIKey ? '&api_key=' + readAPIKey : ''}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.feeds && data.feeds.length > 0) {
                        const feed = data.feeds[0];

                        let temp = parseFloat(feed.field1);
                        let courant = parseFloat(feed.field2);
                        let pression = parseFloat(feed.field3);

                        // üíß Niveau d'huile : robustesse
                        let niveauHuileRaw = (feed.field4 || "").toString().trim().toLowerCase();
                        let niveauHuile = "N/A";

                        if (niveauHuileRaw === "1" || niveauHuileRaw === "haut") {
                            niveauHuile = "Haut";
                        } else if (niveauHuileRaw === "0" || niveauHuileRaw === "bas") {
                            niveauHuile = "Bas";
                        }

                        temp = !isNaN(temp) ? temp.toFixed(2) : "N/A";
                        courant = !isNaN(courant) ? courant.toFixed(2) : "N/A";
                        pression = !isNaN(pression) ? pression.toFixed(2) : "N/A";

                        let alertes = [];

                        if (!isNaN(temp)) {
                            if (temp >= 90) alertes.push("Surchauffe-critique");
                            else if (temp >= 80) alertes.push("Surchauffe");
                        }
                        if (!isNaN(courant) && courant >= 910) alertes.push("Surintensit√©");
                        if (!isNaN(pression) && pression >= 3) alertes.push("Surpression");
                        if (niveauHuile === "Bas") alertes.push("Faible huile");

                        let etat = alertes.length > 0 ? alertes.join(" | ") : "Normal";
                        const dateHeure = feed.created_at ? new Date(feed.created_at).toLocaleString("fr-FR") : "N/A";

                        document.getElementById('data-container').innerHTML = `
                            <h2><i class="fas fa-bolt"></i> Donn√©es r√©centes Transfo-SITEX</h2>
                            <p><i class="fas fa-thermometer-half"></i> Temp√©rature : <strong>${temp} ¬∞C</strong></p>
                            <p><i class="fas fa-charging-station"></i> Courant : <strong>${courant} A</strong></p>
                            <p><i class="fas fa-tachometer-alt"></i> Pression : <strong>${pression} bars</strong></p>
                            <p><i class="fas fa-oil-can"></i> Niveau d'huile : <strong>${niveauHuile}</strong></p>
                            <p><i class="fas fa-exclamation-triangle"></i> √âtat : <strong>${etat}</strong></p>
                            <p><i class="fas fa-clock"></i> Date/Heure : <strong>${dateHeure}</strong></p>
                        `;
                    } else {
                        document.getElementById('data-container').innerHTML = `
                            <h2><i class="fas fa-bolt"></i> Donn√©es r√©centes Transfo-SITEX</h2>
                            <p>‚Ñπ Aucune donn√©e trouv√©e.</p>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('data-container').innerHTML = `
                        <h2><i class="fas fa-bolt"></i> Donn√©es r√©centes Transfo-SITEX</h2>
                        <p>Erreur de chargement : ${error}</p>
                    `;
                });
        }

        // Synchronisation exacte
        function synchronizeRefresh() {
            const now = Date.now();
            const delay = 5000 - (now % 5000);

            setTimeout(() => {
                const seconds = new Date().getSeconds();
                if (seconds % 15 === 0) fetchData();
                synchronizeRefresh();
            }, delay);
        }

        fetchData();           // Appel initial
        synchronizeRefresh();  // Rafra√Æchissement
    </script>
</body>
</html>
