<script>
    const channelID = 2933717;
    const readAPIKey = "6C7J88FPA3BL0998";

    function fetchData() {
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=1${readAPIKey ? '&api_key=' + readAPIKey : ''}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.feeds && data.feeds.length > 0) {
                    const feed = data.feeds[0];

                    let temp = parseFloat(feed.field1);
                    let courant = parseFloat(feed.field2);
                    let pression = parseFloat(feed.field3);
                      let niveauHuileRaw = feed.field4;

                    temp = !isNaN(temp) ? temp.toFixed(2) : "N/A";
                    courant = !isNaN(courant) ? courant.toFixed(2) : "N/A";
                    pression = !isNaN(pression) ? pression.toFixed(2) : "N/A";


                      let niveauHuile = "N/A";
                         if (niveauHuileRaw == 1) niveauHuile = "Haut";
                     else if (niveauHuileRaw == 0) niveauHuile = "Bas";

                    let alertes = [];

                    if (!isNaN(temp)) {
                        if (temp >= 90) alertes.push("Surchauffe-critique");
                        else if (temp >= 80) alertes.push("Surchauffe");
                    }
                    if (!isNaN(courant) && courant >= 910) alertes.push("Surintensité");
                    if (!isNaN(pression) && pression >= 3) alertes.push("Surpression");
                    if (niveauHuile === "Bas") alertes.push("Faible huile");

                    let etat = alertes.length > 0 ? alertes.join(" | ") : "Normal";
                    const dateHeure = feed.created_at ? new Date(feed.created_at).toLocaleString("fr-FR") : "N/A";

                    document.getElementById('data-container').innerHTML = `
                        <h2><i class="fas fa-bolt"></i> Données récentes Transfo-SITEX</h2>
                        <p><i class="fas fa-thermometer-half"></i> Température : <strong>${temp} °C</strong></p>
                        <p><i class="fas fa-charging-station"></i> Courant : <strong>${courant} A</strong></p>
                        <p><i class="fas fa-tachometer-alt"></i> Pression : <strong>${pression} bars</strong></p>
                        <p><i class="fas fa-oil-can"></i> Niveau d'huile : <strong>${niveauHuile}</strong></p>
                        <p><i class="fas fa-exclamation-triangle"></i> État : <strong>${etat}</strong></p>
                        <p><i class="fas fa-clock"></i> Date/Heure : <strong>${dateHeure}</strong></p>
                    `;
                } else {
                    document.getElementById('data-container').innerHTML = `
                        <h2><i class="fas fa-bolt"></i> Données récentes Transfo-SITEX</h2>
                        <p>ℹ Aucune donnée trouvée.</p>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('data-container').innerHTML = `
                    <h2><i class="fas fa-bolt"></i> Données récentes Transfo-SITEX</h2>
                    <p> Erreur de chargement : ${error}</p>
                `;
            });
    }

    // Synchronisation exacte sur les secondes du système (5s)
    const synchronizeRefresh = () => {
        const now = Date.now();
        const delay = 5000 - (now % 5000);

        setTimeout(() => {
            const seconds = new Date().getSeconds();

            // Appel des données toutes les 15 secondes
            if (seconds % 15 === 0) {
                fetchData();
            }

            // Boucle continue toutes les 5s
            synchronizeRefresh();
        }, delay);
    };

    fetchData(); // Appel initial
    synchronizeRefresh(); // Démarre la synchronisation
</script>
