<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Surveillance Transformateur - Dernières données</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #loading { color: blue; font-weight: bold; }
    table { border-collapse: collapse; width: 400px; }
    td, th { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>

<h1>Surveillance Transformateur</h1>

<div id="loading">Chargement des données...</div>

<table>
  <tr><th>Paramètre</th><th>Valeur</th></tr>
  <tr><td>Température</td><td id="temp">--</td></tr>
  <tr><td>Courant</td><td id="courant">--</td></tr>
  <tr><td>Pression</td><td id="pression">--</td></tr>
  <tr><td>Niveau d'huile</td><td id="niveau_huile">--</td></tr>
  <tr><td>État</td><td id="etat">--</td></tr>
  <tr><td>Date/Heure</td><td id="heure_date">--</td></tr>
</table>

<script>
  // REMPLACE ici par ton vrai channel ID ThingSpeak (nombre uniquement)
  const channelID = '2933717';  
  // REMPLACE ici par ta clé API publique (lecture) si nécessaire, sinon laisse vide ''
  const apiKey = '6C7J88FPA3BL0998';

  // Construire l'URL API ThingSpeak
  const apiURL = `https://api.thingspeak.com/channels/${channelID}/feeds/last.json${apiKey ? '?api_key=' + apiKey : ''}`;

  const loading = document.getElementById('loading');

  async function fetchData() {
    try {
      loading.style.display = 'block';
      const response = await fetch(apiURL, {cache: "no-store"});
      if (!response.ok) throw new Error('Erreur réseau');
      const data = await response.json();

      // Affiche les données en récupérant les champs field1 à field5
      updateField('temp', data.field1 ? parseFloat(data.field1).toFixed(2) + ' °C' : '--');
      updateField('courant', data.field2 ? parseFloat(data.field2).toFixed(2) + ' A' : '--');
      updateField('pression', data.field3 ? parseFloat(data.field3).toFixed(2) + ' bars' : '--');

      // Niveau d'huile - on attend 'haut', 'bas', 'high' ou 'low' dans field4
      let nh = data.field4 ? data.field4.toString().toLowerCase() : '';
      if (nh === 'haut' || nh === 'high') {
        updateField('niveau_huile', 'Haut');
      } else if (nh === 'bas' || nh === 'low') {
        updateField('niveau_huile', 'Bas');
      } else {
        updateField('niveau_huile', '--');
      }

      updateField('etat', data.field5 ? data.field5 : '--');

      // Format date/heure création du message
      updateField('heure_date', data.created_at ? formatDateTime(data.created_at) : '--');

      loading.style.display = 'none';
    } catch (e) {
      console.error('Erreur récupération données:', e);
      loading.textContent = 'Erreur chargement';
      setTimeout(() => {
        loading.style.display = 'none';
        loading.textContent = 'Chargement des données...';
      }, 3000);
    }
  }

  function updateField(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function formatDateTime(ts) {
    const d = new Date(ts);
    const pad = n => n < 10 ? '0'+n : n;
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  // Mise à jour toutes les 5 secondes
  setInterval(fetchData, 5000);
  fetchData();
</script>

</body>
</html>
