<script>
    const dataContainer = document.getElementById('data-container');
    const loading = document.getElementById('loading');

    // URL API (change selon ton URL)
    const apiURL = 'https://tonserveur.com/api/latest_data.json';

    async function fetchData() {
        try {
            loading.classList.add('show');
            const response = await fetch(apiURL, {cache: "no-store"});
            if (!response.ok) throw new Error('Erreur réseau');
            const data = await response.json();

            updateField('temp', data.Temperature);
            updateField('courant', data.Courant);
            updateField('pression', data.Pression);

            // Correction Niveau d'huile ici :
            let niveauHuile = data.Niveau_huile ? data.Niveau_huile.toString().toLowerCase() : '';
            if (niveauHuile === 'haut' || niveauHuile === 'high') {
                updateField('niveau_huile', 'Haut');
            } else if (niveauHuile === 'bas' || niveauHuile === 'low') {
                updateField('niveau_huile', 'Bas');
            } else {
                updateField('niveau_huile', 'Inconnu');
            }

            updateField('etat', data.Etat);
            updateField('heure_date', data.Heure_date);

            loading.classList.remove('show');
        } catch (e) {
            console.error('Erreur récupération données:', e);
            loading.textContent = 'Erreur chargement';
            setTimeout(() => loading.classList.remove('show'), 3000);
        }
    }

    function updateField(id, value) {
        const el = document.getElementById(id);
        if (!el) return;

        if (el.textContent !== String(value)) {
            el.textContent = value;
            el.classList.remove('fade-in');
            void el.offsetWidth; // reset animation
            el.classList.add('fade-in');
        }
    }

    function syncFetch(interval = 5) {
        fetchData();
        const now = new Date();
        const seconds = now.getSeconds();
        const milliseconds = now.getMilliseconds();
        const delay = (interval - (seconds % interval)) * 1000 - milliseconds;

        setTimeout(() => {
            syncFetch(interval);
        }, delay);
    }

    syncFetch(5);
</script>
